// @flow

import * as React from 'react';
import { defineMessages, FormattedMessage as M } from 'react-intl';

import SimpleDialog from '../../misc/SimpleDialog';

import { Project } from '../../../core/store/projects';

const messages = defineMessages({
  title: {
    id: 'app.projects.unlink_project_dialog.title',
    description: 'Title for the project unlink dialog',
    defaultMessage: 'Confirm unlink',
  },
  description: {
    id: 'app.projects.unlink_project_dialog.description',
    description: 'Text for the project unlink dialog',
    defaultMessage:
      'This action removes the association between the project and the exercise it was cloned from. ' +
      'After unlinking, the project can no longer be opened from the exercise list, ' +
      'but it can be uploaded as a new exercise.',
  },
});

type SimpleDialogProps = React.ElementProps<typeof SimpleDialog>;

// this type has all properties that are generated by mountSimpleDialog()
type MountedSimpleDialogProps = $Diff<
  SimpleDialogProps,
  // these are the ones that aren't
  {|
    id: $PropertyType<SimpleDialogProps, 'id'>,
  |},
>;

type UnlinkProjectDialogHook = {|
  show(project: Project): void,
  mountSimpleDialog(): MountedSimpleDialogProps,
|};

type Config = {|
  project: Project,
|};

export default function useUnlinkProjectDialog(
  onUnlink: (Project) => boolean | Promise<boolean>,
): UnlinkProjectDialogHook {
  const [open, setOpen] = React.useState<boolean>(false);
  const [config, setConfig] = React.useState<Config | null>(null);

  function show(project: Project) {
    setOpen(true);
    setConfig({ project });
  }

  function onCancel() {
    setOpen(false);
  }

  async function onConfirm() {
    // eslint-disable-next-line no-throw-literal
    if (!open) throw 'dialog is not shown';
    // eslint-disable-next-line no-throw-literal
    if (config === null) throw 'unreachable';

    const { project } = config;

    // whether the deletion succeeded or not, we want to hide the dialog.
    // Thus, ignore the result of onUnlink
    await onUnlink(project);

    // we don't set the project to null because that results in a display glitch:
    // the hide animation will leave the project name visible for a split second
    setOpen(false);
  }

  const name = config?.project.name ?? '';

  return {
    show,
    mountSimpleDialog() {
      return {
        open,
        valid: true,
        title: <M {...messages.title} />,
        description: <M {...messages.description} values={{ name }} />,
        actions: 'OK_autofocus_CANCEL',
        onCancel,
        onConfirm,
      };
    },
  };
}
